<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test Autenticación</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 600px; margin: 0 auto; }
        .test { border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: #f9f9f9; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Test Sistema de Autenticación</h1>
    <div id="tests"></div>
    
    <script src="./js/auth.js"></script>
    <script>
        const testsDiv = document.getElementById('tests');
        
        function test(nombre, fn) {
            try {
                fn();
                console.log(`✓ ${nombre}`);
                addTestLog(`✓ ${nombre}`, true);
            } catch (e) {
                console.error(`✗ ${nombre}: ${e.message}`);
                addTestLog(`✗ ${nombre}: ${e.message}`, false);
            }
        }
        
        function addTestLog(msg, success) {
            const div = document.createElement('div');
            div.className = 'test ' + (success ? 'success' : 'error');
            div.textContent = msg;
            testsDiv.appendChild(div);
        }
        
        // Limpiar localStorage antes de tests
        localStorage.clear();
        
        // Test 1: Registrar usuario
        test('Registrar usuario nuevo', () => {
            const resultado = registrarUsuario('test@example.com', '1234');
            if (!resultado.exito) throw new Error(resultado.mensaje);
            console.log('Usuario registrado:', resultado);
        });
        
        // Test 2: No permitir email duplicado
        test('Rechazar email duplicado', () => {
            const resultado = registrarUsuario('test@example.com', '5678');
            if (resultado.exito) throw new Error('Debería rechazar email duplicado');
        });
        
        // Test 3: Login correcto
        test('Login con credenciales correctas', () => {
            const resultado = loginUsuario('test@example.com', '1234');
            if (!resultado.exito) throw new Error(resultado.mensaje);
        });
        
        // Test 4: Verificar usuario logueado
        test('Verificar usuario logueado', () => {
            if (!hayUsuarioLogueado()) throw new Error('Usuario no está logueado');
            const nombre = obtenerNombreUsuario();
            if (nombre !== 'test@example.com') throw new Error('Email incorrecto');
        });
        
        // Test 5: Guardar compra de usuario
        test('Guardar compra para usuario', () => {
            const compra = {
                id: Date.now(),
                fecha: new Date().toLocaleString(),
                productos: [{id: 1, titulo: 'Producto Test', precio: 10}],
                total: 10
            };
            guardarCompraUsuario(compra);
            const historial = obtenerHistorialUsuario();
            if (!historial || historial.length === 0) throw new Error('Compra no se guardó');
        });
        
        // Test 6: Obtener historial del usuario
        test('Obtener historial de compras', () => {
            const historial = obtenerHistorialUsuario();
            if (!Array.isArray(historial)) throw new Error('Historial no es un array');
            if (historial.length === 0) throw new Error('Historial vacío');
        });
        
        // Test 7: Cerrar sesión
        test('Cerrar sesión sin error', () => {
            // Temporalmente reemplazamos location.href para no redirigir
            const originalLocation = window.location;
            Object.defineProperty(window, 'location', {
                value: { href: '' },
                writable: true
            });
            
            // Solo limpiamos localStorage manualmente
            localStorage.removeItem("usuario-actual");
            localStorage.removeItem("productos-en-carrito");
            
            if (hayUsuarioLogueado()) throw new Error('Usuario sigue logueado');
        });
        
        // Test 8: Registrar segundo usuario
        test('Registrar segundo usuario', () => {
            const resultado = registrarUsuario('usuario2@example.com', '5678');
            if (!resultado.exito) throw new Error(resultado.mensaje);
        });
        
        // Test 9: Verificar historial separado por usuario
        test('Historial separado por usuario', () => {
            // Login como usuario 2
            loginUsuario('usuario2@example.com', '5678');
            const historialUsuario2 = obtenerHistorialUsuario();
            
            // Debe estar vacío para usuario 2
            if (historialUsuario2.length > 0) throw new Error('Historial de usuario 2 no debe estar vacío después de login');
        });
        
        console.log('✓ Tests completados');
        addTestLog('✓ Todos los tests completados', true);
    </script>
</body>
</html>
